name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.9, 3.11]

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Create data directories
      run: |
        mkdir -p data/raw data/processed data/vector_db
        echo "Data directories created"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install --no-cache-dir -r requirements.txt
        pip install pytest
    
    - name: Force install latest compatible versions
      run: |
        pip install --upgrade --force-reinstall sentence-transformers>=5.0.0
        pip install --upgrade --force-reinstall huggingface_hub>=0.20.0
    
    - name: Download NLTK data
      run: |
        python -c "import nltk; nltk.download('punkt'); nltk.download('stopwords')"
    
    - name: Debug dependencies
      run: |
        python -c "import sentence_transformers; print('sentence-transformers version:', sentence_transformers.__version__)"
        python -c "import huggingface_hub; print('huggingface_hub version:', huggingface_hub.__version__)"
        python -c "from sentence_transformers import SentenceTransformer; print('SentenceTransformer import successful')"
    
    - name: Test HuggingFace compatibility
      run: |
        python -m pytest tests/test_huggingface_compatibility.py -v -s
    
    - name: Test imports
      run: |
        python -m pytest tests/test_imports.py -v
    
    - name: Run tests
      run: |
        python -m pytest tests/test_basic.py -v